<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPTPilot | Arena & Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f5f7fb;
            --ink: #0f172a;
            --muted: #6b7280;
            --card: rgba(255, 255, 255, 0.9);
            --border: #e5e7eb;
            --accent: #4f46e5;
            --accent-2: #0ea5e9;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(120% 120% at 12% 20%, rgba(79, 70, 229, 0.12), transparent 40%), radial-gradient(120% 120% at 88% 0%, rgba(14, 165, 233, 0.14), transparent 42%), var(--bg);
            color: var(--ink);
            min-height: 100vh;
        }

        .topbar {
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: saturate(180%) blur(10px);
            background: rgba(255, 255, 255, 0.72);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .nav-link {
            color: #475569;
            font-weight: 600;
        }

        .nav-link:hover {
            color: #0f172a;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.65rem;
            border-radius: 9999px;
            background: linear-gradient(120deg, rgba(79, 70, 229, 0.12), rgba(14, 165, 233, 0.1));
            color: #1f2937;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .page {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.75rem 1.5rem 2.5rem 1.5rem;
        }

        .hero {
            background: linear-gradient(120deg, rgba(79, 70, 229, 0.08), rgba(14, 165, 233, 0.08));
            border: 1px solid rgba(226, 232, 240, 0.9);
            border-radius: 1.25rem;
            padding: 1.6rem;
            display: grid;
            gap: 1rem;
            grid-template-columns: 2fr 1.1fr;
            box-shadow: 0 18px 38px -25px rgba(15, 23, 42, 0.35);
        }

        .hero h1 {
            font-size: clamp(1.6rem, 2vw, 2.2rem);
            letter-spacing: -0.02em;
        }

        .hero p {
            color: var(--muted);
            max-width: 46ch;
        }

        .hero-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.65rem;
        }

        .metric {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--border);
            border-radius: 0.9rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.65rem;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .metric-icon {
            height: 32px;
            width: 32px;
            border-radius: 0.75rem;
            display: grid;
            place-items: center;
            background: #eef2ff;
            color: var(--accent);
            font-weight: 700;
        }

        .metric>div span {
            color: var(--muted);
            font-size: 0.78rem;
            display: block;
        }

        .metric>div strong {
            font-size: 1.05rem;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px -30px rgba(15, 23, 42, 0.35);
            transition: transform .15s ease, box-shadow .2s ease;
        }

        .card:hover {
            transform: translateY(-1px);
            box-shadow: 0 28px 52px -34px rgba(15, 23, 42, 0.42);
        }

        .card h3 {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            margin-bottom: 0.85rem;
        }

        .eyebrow {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #4b5563;
            font-weight: 700;
        }

        .input-field {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.65rem;
            padding: 0.7rem 0.85rem;
            background: rgba(255, 255, 255, 0.9);
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 0.95rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
        }

        .hint {
            font-size: 0.82rem;
            color: #6b7280;
        }

        .surface {
            background: #f8fafc;
            border: 1px dashed #e2e8f0;
            border-radius: 0.9rem;
            padding: 0.9rem;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chip {
            background: #eef2ff;
            color: #312e81;
            padding: 0.35rem 0.7rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .btn {
            position: relative;
            padding: 0.78rem 1rem;
            border-radius: 0.9rem;
            font-weight: 700;
            text-align: center;
            border: 1px solid #dfe3ee;
            background: linear-gradient(120deg, #111827, #0f172a);
            color: white;
            box-shadow: 0 12px 30px -16px rgba(15, 23, 42, 0.45), 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
            overflow: hidden;
        }

        .btn.secondary {
            background: white;
            color: var(--ink);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 20px 40px -25px rgba(15, 23, 42, 0.35);
        }

        .btn:active {
            transform: translateY(0);
        }

        .loader {
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out forwards;
        }

        .judgement-container {
            margin-top: 0.85rem;
            padding: 1rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
        }

        .viewer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.1rem;
            margin-top: 1rem;
        }

        .viewer-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 18px 36px -28px rgba(15, 23, 42, 0.35);
        }

        .pdf-viewer {
            width: 100%;
            height: 75vh;
            border: 1px solid #e2e8f0;
            border-radius: 0.9rem;
            background-color: #f1f5f9;
        }

        .file-tag {
            font-size: 0.8rem;
            color: #475569;
        }

        .pill {
            padding: 0.45rem 0.75rem;
            background: #0f172a;
            color: white;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1.1fr 1fr 0.9fr;
            gap: 1.1rem;
            margin-top: 1.15rem;
        }

        .title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .chat-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0.65rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.85rem;
            min-height: 0;
        }

        .chat-history-entry {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.75rem;
        }

        .chat-bubble-user {
            background: #111827;
            color: #fff;
            border-radius: 1rem 1rem 0.6rem 1rem;
            padding: 0.65rem 0.9rem;
            margin-bottom: 0.55rem;
            max-width: 85%;
            align-self: flex-end;
            box-shadow: 0 8px 18px -12px rgba(15, 23, 42, 0.35);
        }

        .chat-bubble-llm {
            background: #eef2ff;
            color: #0f172a;
            border-radius: 1rem 1rem 1rem 0.6rem;
            padding: 0.65rem 0.9rem;
            margin-bottom: 1rem;
            max-width: 85%;
            align-self: flex-start;
        }

        .chat-input {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        textarea {
            border: 1px solid #e2e8f0;
            border-radius: 0.85rem;
            padding: 0.75rem 0.85rem;
            resize: vertical;
            min-height: 80px;
            font-size: 0.98rem;
            background: rgba(255, 255, 255, 0.95);
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
        }

        .history-entry {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.8rem;
            padding: 0.8rem;
        }

        .tab-switch {
            display: inline-flex;
            gap: 0.6rem;
            padding: 0.35rem;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border);
            border-radius: 999px;
            box-shadow: 0 14px 30px -24px rgba(15, 23, 42, 0.35);
        }

        .tab-pill {
            padding: 0.6rem 1.1rem;
            border-radius: 999px;
            font-weight: 700;
            background: transparent;
            border: none;
            color: #475569;
            cursor: pointer;
        }

        .tab-pill.active {
            background: #0f172a;
            color: white;
            box-shadow: 0 10px 24px -18px rgba(15, 23, 42, 0.4);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .clamp-two {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 1160px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .hero {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="mx-auto max-w-[1600px] px-5 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="h-10 w-10 rounded-lg bg-indigo-600 text-white flex items-center justify-center font-semibold text-lg shadow-sm">
                    P</div>
                <div>
                    <div id="appTitle" class="text-base font-semibold text-slate-800 tracking-tight leading-tight">
                        PPTArena</div>
                    <div class="text-xs text-slate-500 font-medium">Evaluate and edit decks</div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="tab-switch">
                    <button class="tab-pill" data-tab-target="evaluation">Evaluation</button>
                    <button class="tab-pill" data-tab-target="chat">Chat</button>
                </div>

                <div class="relative">
                    <details class="group relative">
                        <summary
                            class="flex items-center gap-2 cursor-pointer list-none font-semibold text-slate-600 text-sm hover:text-slate-900 transition-colors px-3 py-2 rounded-lg hover:bg-slate-100">
                            <span>API Keys</span>
                            <svg class="w-4 h-4 transition group-open:rotate-180" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div
                            class="absolute right-0 top-full mt-2 w-72 bg-white rounded-xl shadow-xl border border-slate-200 p-4 z-50 group-open:animate-fadeIn origin-top-right">
                            <label for="api_key_openai" class="font-semibold text-slate-800 block mb-1 text-xs">OpenAI
                                API Key</label>
                            <input type="password" id="api_key_openai" class="input-field mb-3 text-sm py-1.5"
                                placeholder="sk-...">

                            <label for="api_key_gemini" class="font-semibold text-slate-800 block mb-1 text-xs">Gemini
                                API Key</label>
                            <input type="password" id="api_key_gemini" class="input-field text-sm py-1.5"
                                placeholder="AIza...">

                            <p class="hint mt-2 text-xs text-slate-500">Keys are stored locally in your browser.</p>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <main class="page">
        <div class="project-header text-center mb-8 pt-6">
            <h1 class="text-3xl md:text-4xl font-bold mb-3 tracking-tight text-slate-900">PPTArena: A Benchmark for
                Agentic PowerPoint Editing</h1>
            <div class="text-base text-slate-600 mb-6 font-medium">
                <span class="mr-4">Michael Ofengenden</span> <span class="mr-4">Yunze Man</span> <span class="mr-4">Ziqi
                    Pang</span> <span>Yu-Xiong Wang</span>
            </div>
            <div class="flex justify-center gap-3 mb-8">
                <a href="https://arxiv.org/abs/2512.03042" target="_blank"
                    class="btn secondary flex items-center gap-2 hover:bg-slate-50 py-1.5 px-4 text-sm">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                    </svg>
                    Paper
                </a>
                <a href="https://github.com/michaelofengend/PPTArena" target="_blank"
                    class="btn secondary flex items-center gap-2 hover:bg-slate-50 py-1.5 px-4 text-sm">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                    Code
                </a>
                <a href="https://arxiv.org/pdf/2512.03042" target="_blank"
                    class="btn secondary flex items-center gap-2 hover:bg-slate-50 py-1.5 px-4 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                        </path>
                    </svg>
                    PDF
                </a>
            </div>
        </div>

        <div id="evaluationTab" class="tab-panel active">
            <section id="controls" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="card border-0 shadow-lg shadow-slate-200/50 ring-1 ring-slate-200">
                    <h3 class="text-slate-800"><span
                            class="flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold">1</span>
                        Select test case</h3>
                    <div class="flex-grow flex flex-col gap-4">
                        <div>
                            <label for="evaluationPairSelector"
                                class="font-semibold text-slate-700 text-sm block mb-1.5">Test case</label>
                            <select id="evaluationPairSelector" class="input-field text-sm">
                                {% for pair in evaluation_pairs %}
                                <option value="{{ pair.name }}" {% if pair.name==selected_pair.name %}selected{% endif
                                    %}>{{ pair.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-4 pt-2">
                            <div>
                                <p class="font-semibold text-slate-700 text-xs uppercase tracking-wider mb-1">Prompt</p>
                                <p class="text-slate-600 text-sm leading-relaxed" id="promptDisplay">{{
                                    selected_pair.prompt }}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-700 text-xs uppercase tracking-wider mb-1">Style
                                    target</p>
                                <p class="text-slate-600 text-sm leading-relaxed clamp-two" id="styleDisplay"
                                    title="{{ selected_pair.style_target }}">{{ selected_pair.style_target }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-lg shadow-slate-200/50 ring-1 ring-slate-200">
                    <h3 class="text-slate-800"><span
                            class="flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold">2</span>
                        Generate prediction</h3>
                    <form id="evalForm" class="flex-grow flex flex-col gap-4">
                        <input type="hidden" id="eval_prompt" name="prompt" value="{{ selected_pair.prompt }}">
                        <input type="hidden" id="eval_original_filepath" name="original_filepath"
                            value="{{ selected_pair.original }}">
                        <div>
                            <label for="eval_llm_engine" class="font-semibold text-slate-700 text-sm block mb-1.5">LLM
                                engine</label>
                            <select id="eval_llm_engine" name="llm_engine" class="input-field text-sm">
                                <optgroup label="Google Gemini">
                                    <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                                </optgroup>
                                <optgroup label="OpenAI GPT">
                                    <option value="gpt-4o">GPT-4o</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                    <option value="gpt-5-2025-08-07" selected>GPT-5 (2025-08-07)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="flex items-center gap-2.5 text-sm text-slate-600">
                            <input type="checkbox" id="eval_force_python_pptx"
                                class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="eval_force_python_pptx" class="select-none font-medium">Use python-pptx
                                only</label>
                        </div>
                        <div>
                            <label for="eval_loop_iterations"
                                class="font-semibold text-slate-700 text-sm block mb-1.5">Max iterations</label>
                            <input type="number" id="eval_loop_iterations" name="loop_iterations"
                                class="input-field text-sm" min="1" max="10" value="3">
                            <p class="hint mt-1">Used when running Loop for iterative refinement.</p>
                        </div>
                        <div id="generationTimeDisplay" class="text-xs text-slate-600 font-semibold"
                            style="display:none;"></div>
                        <div class="flex-grow"></div>
                        <div class="grid grid-cols-1 gap-2.5">
                            <button type="submit" class="btn text-sm py-2">Generate prediction</button>
                            <button type="button" id="eval_loopButton" class="btn secondary text-sm py-2">Loop</button>
                        </div>
                    </form>
                </div>

                <div class="card border-0 shadow-lg shadow-slate-200/50 ring-1 ring-slate-200">
                    <h3 class="text-slate-800"><span
                            class="flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold">3</span>
                        LLM judge</h3>
                    <div class="flex-grow flex flex-col">
                        <p class="text-sm text-slate-500 mb-4 leading-relaxed">The judge compares <strong>Ground
                                Truth</strong> vs <strong>Prediction</strong> with the original as baseline.</p>
                        <label for="judge_model" class="font-semibold text-slate-700 text-sm block mb-1.5">Judge
                            model</label>
                        <select id="judge_model" class="input-field mb-4 text-sm">
                            <optgroup label="Google Gemini">
                                <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                            </optgroup>
                            <optgroup label="OpenAI GPT">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-5-2025-08-07" selected>GPT-5 (2025-08-07)</option>
                            </optgroup>
                        </select>
                        <div id="judgeTimeDisplay" class="text-xs text-slate-600 font-semibold mb-2"
                            style="display:none;"></div>
                        <div id="judgementDisplay" class="judgement-container" style="display:none;"></div>
                    </div>
                    <button id="judgeButton" class="btn secondary mt-4 text-sm py-2">Call LLM Judge</button>
                </div>
            </section>

            <section class="mb-6">
                <div class="flex items-center justify-between gap-3 mb-3 flex-wrap">
                    <div class="flex items-center gap-2 text-slate-700">
                        <div id="evalLoader" class="loader"></div>
                        <span class="font-semibold">Status & progress</span>
                    </div>
                    <span class="hint">Live poller stops automatically after ~2 minutes.</span>
                </div>
                <div id="evalMessageArea" class="border border-slate-200 rounded-xl bg-white/80 p-3 min-h-[48px]"></div>
            </section>

            <section class="viewer">
                <div class="viewer-card">
                    <h2 class="text-lg font-semibold mb-1 text-slate-900">Ground Truth</h2>
                    <p class="file-tag mb-3 truncate" title="{{ selected_pair.ground_truth }}">{{
                        selected_pair.ground_truth.split('/')[-1] }}</p>
                    {% if test_pdf_name %}
                    <iframe id="testPdfViewer" src="{{ url_for('view_pdf', pdf_path=test_pdf_name) }}"
                        class="pdf-viewer"></iframe>
                    {% elif public_gt_url %}
                    <iframe id="testPdfViewer"
                        src="https://view.officeapps.live.com/op/embed.aspx?src={{ public_gt_url }}"
                        class="pdf-viewer"></iframe>
                    {% else %}
                    <div class="pdf-viewer flex items-center justify-center text-slate-500">PDF not available.</div>
                    {% endif %}
                </div>
                <div class="viewer-card">
                    <div class="flex items-center justify-between mb-1">
                        <h2 class="text-lg font-semibold text-slate-900">
                            {% if is_prediction %}
                            Prediction
                            {% else %}
                            Original
                            {% endif %}
                        </h2>
                        <div class="flex items-center gap-2">
                            <label for="manualPredictionUpload"
                                class="text-xs font-semibold text-indigo-600 cursor-pointer hover:text-indigo-800 transition-colors">
                                Upload Prediction
                                <input type="file" id="manualPredictionUpload" accept=".pptx" class="hidden">
                            </label>
                            <span class="badge">Side-by-side view</span>
                        </div>
                    </div>
                    <p class="file-tag mb-3 truncate" id="predictionFilenameDisplay"
                        title="{{ prediction_pptx_name or '' }}">
                        {% if is_prediction %}
                        {{ prediction_pptx_name or 'No prediction generated yet' }}
                        {% else %}
                        {{ selected_pair.original.split('/')[-1] }}
                        {% endif %}
                    </p>
                    {% if prediction_pdf_name %}
                    <iframe id="predictionPdfViewer" src="{{ url_for('view_pdf', pdf_path=prediction_pdf_name) }}"
                        class="pdf-viewer"></iframe>
                    {% elif public_pred_url %}
                    <iframe id="predictionPdfViewer"
                        src="https://view.officeapps.live.com/op/embed.aspx?src={{ public_pred_url }}"
                        class="pdf-viewer"></iframe>
                    {% else %}
                    <div id="predictionPdfViewer" class="pdf-viewer flex items-center justify-center text-slate-500">No
                        prediction generated yet.</div>
                    {% endif %}
                </div>
            </section>
        </div>

        <div id="chatTab" class="tab-panel">
            <section class="main-grid">
                <div class="card">
                    <div class="title-row">
                        <div>
                            <p class="eyebrow">Workspace</p>
                            <h2 class="text-xl font-semibold">Upload & authenticate</h2>
                        </div>
                    </div>
                    <form id="chatPptForm" enctype="multipart/form-data" class="flex flex-col gap-4">
                        <div class="surface">
                            <div class="flex items-center justify-between gap-3 flex-wrap">
                                <div>
                                    <p class="font-semibold text-slate-900">Upload PPTX</p>
                                    <p class="text-sm text-slate-600">Drop in your starting deck to begin editing.</p>
                                </div>
                                <label for="chat_ppt_file" class="btn secondary" style="padding:0.65rem 0.9rem;">Choose
                                    file<input type="file" id="chat_ppt_file" name="file" accept=".pptx" required
                                        class="sr-only"></label>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Shared API key above powers this tab.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="chat_llm_engine" class="font-medium text-slate-800 block mb-1">LLM
                                    model</label>
                                <select id="chat_llm_engine" name="llm_engine" class="input-field">
                                    <optgroup label="Google Gemini">
                                        <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                                    </optgroup>
                                    <optgroup label="OpenAI GPT">
                                        <option value="gpt-5.1-2025-11-13">GPT-5.1 (2025-11-13)</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </form>
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="loader" id="chatLoader"></div>
                            <span class="font-semibold text-slate-800">Live status</span>
                        </div>
                        <div id="chatMessageArea" class="surface"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="title-row">
                        <div>
                            <p class="eyebrow">Preview</p>
                            <h2 class="text-xl font-semibold">Current file</h2>
                        </div>
                        <a id="chatModifiedPptxDownload" href="#" target="_blank"
                            class="text-indigo-600 font-semibold text-sm">Download latest</a>
                    </div>
                    <section id="chatPreviewSection" class="flex flex-col gap-2" style="display:none;">
                        <iframe id="chatModifiedPptIframe" class="pdf-viewer" style="height:520px;"></iframe>
                    </section>
                    <section class="flex flex-col gap-3">
                        <div class="title-row">
                            <h3 class="font-semibold text-slate-900">Edit history</h3>
                            <span class="text-xs text-slate-500">Every save is downloadable</span>
                        </div>
                        <div id="chatEditHistoryContainer" class="flex flex-col gap-3"></div>
                    </section>
                </div>

                <aside id="chatSidebar" class="card chat-pane">
                    <div class="title-row">
                        <div>
                            <p class="eyebrow">Chat</p>
                            <h2 class="text-xl font-semibold">Talk to PPTPilot</h2>
                        </div>
                        <span class="text-xs text-slate-500">Session stays while tab is open</span>
                    </div>
                    <div class="chat-history" id="chatHistory"></div>
                    <form id="chatForm" class="chat-input">
                        <textarea id="chat_prompt" rows="3" placeholder="Explain the change you want..."
                            class="w-full"></textarea>
                        <button type="submit" class="btn w-full">Send instruction</button>
                    </form>
                    <p class="text-xs text-slate-500">Upload a deck to start a session. Shared API key above powers
                        edits.</p>
                </aside>
            </section>
        </div>
    </main>

    <script id="evaluationPairsData" type="application/json">{{ evaluation_pairs | tojson | safe }}</script>

    <script id="defaultTabData" type="application/json">{{ (active_tab or 'evaluation') | tojson | safe }}</script>
    <script>
        const defaultTab = JSON.parse(document.getElementById('defaultTabData').textContent);
        const tabButtons = document.querySelectorAll('[data-tab-target]');
        const tabPanels = {
            evaluation: document.getElementById('evaluationTab'),
            chat: document.getElementById('chatTab'),
        };

        function activateTab(name) {
            const target = name === 'chat' ? 'chat' : 'evaluation';
            tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tabTarget === target));
            Object.entries(tabPanels).forEach(([key, el]) => {
                if (!el) return;
                el.classList.toggle('active', key === target);
                el.style.display = key === target ? 'block' : 'none';
            });

            const metricPair = document.getElementById('metricPair');
            const metricLoop = document.getElementById('metricLoop');
            const chipLoop = document.getElementById('loopIterationsPreview');
            if (metricPair) metricPair.style.display = target === 'evaluation' ? 'flex' : 'none';
            if (metricLoop) metricLoop.style.display = target === 'evaluation' ? 'flex' : 'none';
            updateEnginePreview(target);
            const url = new URL(window.location.href);
            url.searchParams.set('tab', target);
            window.history.replaceState({}, '', url);

            const appTitle = document.getElementById('appTitle');
            if (appTitle) {
                appTitle.textContent = target === 'chat' ? 'PPTPilot' : 'PPTArena';
            }
        }
        tabButtons.forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget)));
        activateTab(defaultTab);
    </script>
    <script id="pageStateData" type="application/json">
    {
        "predictionPptxName": {{ (prediction_pptx_name or "") | tojson | safe }},
        "selectedPairName": {{ selected_pair.name | tojson | safe }}
    }
    </script>
    <script>
        // Shared references
        const apiKeyOpenAIInput = document.getElementById('api_key_openai');
        const apiKeyGeminiInput = document.getElementById('api_key_gemini');

        const savedOpenAIKey = localStorage.getItem('pptpilot_openai_api_key');
        const savedGeminiKey = localStorage.getItem('pptpilot_gemini_api_key');

        if (savedOpenAIKey && apiKeyOpenAIInput) apiKeyOpenAIInput.value = savedOpenAIKey;
        if (savedGeminiKey && apiKeyGeminiInput) apiKeyGeminiInput.value = savedGeminiKey;

        if (apiKeyOpenAIInput) {
            apiKeyOpenAIInput.addEventListener('input', () => localStorage.setItem('pptpilot_openai_api_key', apiKeyOpenAIInput.value));
        }
        if (apiKeyGeminiInput) {
            apiKeyGeminiInput.addEventListener('input', () => localStorage.setItem('pptpilot_gemini_api_key', apiKeyGeminiInput.value));
        }

        function isOpenAIModel(modelId) {
            if (!modelId) return false;
            const lower = modelId.toLowerCase();
            return lower.includes('gpt') || lower.includes('openai') || lower.includes('o1') || lower.includes('o3') || lower.includes('o4');
        }

        function validateApiKeys(modelId) {
            if (isOpenAIModel(modelId)) {
                if (!apiKeyOpenAIInput || !apiKeyOpenAIInput.value.trim()) {
                    return { valid: false, provider: 'OpenAI' };
                }
            } else {
                // Assume Gemini/Google for everything else
                if (!apiKeyGeminiInput || !apiKeyGeminiInput.value.trim()) {
                    return { valid: false, provider: 'Gemini' };
                }
            }
            return { valid: true };
        }

        // Evaluation tab elements
        const pairSelector = document.getElementById('evaluationPairSelector');
        const evalForm = document.getElementById('evalForm');
        const judgeButton = document.getElementById('judgeButton');
        const evalLoader = document.getElementById('evalLoader');
        const evalMessageArea = document.getElementById('evalMessageArea');
        let progressInterval = null;
        let progressIndex = 0;
        let currentRequestId = null;
        const judgementDisplay = document.getElementById('judgementDisplay');
        const evalPromptInput = document.getElementById('eval_prompt');
        const originalFileInput = document.getElementById('eval_original_filepath');
        const forcePythonCheckbox = document.getElementById('eval_force_python_pptx');
        const loopButton = document.getElementById('eval_loopButton');
        const loopIterationsInput = document.getElementById('eval_loop_iterations');
        const judgeModelSelect = document.getElementById('judge_model');
        const generationTimeDisplay = document.getElementById('generationTimeDisplay');
        const judgeTimeDisplay = document.getElementById('judgeTimeDisplay');
        const loopIterationsPreview = document.getElementById('loopIterationsPreview');
        const enginePreview = document.getElementById('enginePreview');
        const activePairLabel = document.getElementById('activePairLabel');
        const llmEngineSelect = document.getElementById('eval_llm_engine');

        const evaluationPairs = JSON.parse(document.getElementById('evaluationPairsData').textContent || '[]');
        const pageState = JSON.parse(document.getElementById('pageStateData').textContent);
        let currentPredictionPptxName = pageState.predictionPptxName;
        let selectedPairName = pageState.selectedPairName;
        let currentGenerationTime = null;
        let currentLLMEngine = null;

        // Display generation time from URL if available (persists after redirect)
        const urlParams = new URLSearchParams(window.location.search);
        const generationTimeFromUrl = urlParams.get('generation_time');
        const llmEngineFromUrl = urlParams.get('llm_engine');
        if (generationTimeFromUrl) {
            generationTimeDisplay.textContent = `⏱️ Generation time: ${generationTimeFromUrl}s`;
            generationTimeDisplay.style.display = 'block';
            currentGenerationTime = parseFloat(generationTimeFromUrl);
        }
        if (llmEngineFromUrl) {
            currentLLMEngine = llmEngineFromUrl;
        }

        function updateEnginePreview(activeTabName) {
            if (!enginePreview) return;
            const targetTab = activeTabName || (tabButtons && Array.from(tabButtons).find(btn => btn.classList.contains('active'))?.dataset.tabTarget) || 'evaluation';
            if (targetTab === 'chat') {
                const chatSelect = document.getElementById('chat_llm_engine');
                const sel = chatSelect ? chatSelect.options[chatSelect.selectedIndex] : null;
                enginePreview.textContent = sel ? sel.textContent : '—';
            } else {
                if (!llmEngineSelect) return;
                const selected = llmEngineSelect.options[llmEngineSelect.selectedIndex];
                enginePreview.textContent = selected ? selected.textContent : '—';
            }
        }

        function updateLoopPreview() {
            if (!loopIterationsPreview || !loopIterationsInput) return;
            loopIterationsPreview.textContent = loopIterationsInput.value || '3';
        }

        function updateActivePairLabel(name) {
            if (activePairLabel && name) {
                activePairLabel.textContent = name;
            }
        }

        if (llmEngineSelect && llmEngineFromUrl) {
            const exists = Array.from(llmEngineSelect.options).some(opt => opt.value === llmEngineFromUrl);
            if (exists) llmEngineSelect.value = llmEngineFromUrl;
        }
        updateEnginePreview(defaultTab);
        if (llmEngineSelect) llmEngineSelect.addEventListener('change', () => updateEnginePreview('evaluation'));
        updateLoopPreview();
        updateActivePairLabel(selectedPairName);

        // Request notification permission on page load
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        // Create audio context for notification sounds
        function playNotificationSound(isSuccess = true) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                if (isSuccess) {
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    oscillator.type = 'sine';
                } else {
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime + 0.1);
                    oscillator.type = 'square';
                }
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (_) { }
        }

        function showNotification(title, body, isSuccess = true) {
            playNotificationSound(isSuccess);
            if ("Notification" in window && Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: isSuccess ? 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234ade80"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f87171"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234f46e5"><text x="12" y="18" font-size="16" text-anchor="middle" fill="white" font-weight="bold">P</text></svg>',
                    tag: 'pptpilot-eval',
                    requireInteraction: false,
                    silent: false
                });
                setTimeout(() => notification.close(), 5000);
            } else if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") showNotification(title, body, isSuccess);
                });
            }
        }

        pairSelector.addEventListener('change', function () {
            const newPairName = this.value;
            updateActivePairLabel(newPairName);
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('pair', newPairName);
            currentUrl.searchParams.delete('prediction_pptx_path');
            currentUrl.searchParams.delete('generation_time');
            window.location.href = currentUrl.toString();
        });

        evalForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const modelId = llmEngineSelect.value;
            const validation = validateApiKeys(modelId);
            if (!validation.valid) {
                displayEvalMessage(`Error: ${validation.provider} API Key is required for model '${modelId}'. Please enter it in the top bar.`, 'error');
                return;
            }
            submitPrediction({ loopMode: false });
        });

        if (loopButton) loopButton.addEventListener('click', () => {
            const modelId = llmEngineSelect.value;
            const validation = validateApiKeys(modelId);
            if (!validation.valid) {
                displayEvalMessage(`Error: ${validation.provider} API Key is required for model '${modelId}'. Please enter it in the top bar.`, 'error');
                return;
            }
            submitPrediction({ loopMode: true });
        });

        async function submitPrediction({ loopMode = false } = {}) {
            if (evalLoader) evalLoader.style.display = 'block';
            evalMessageArea.innerHTML = '';
            judgementDisplay.style.display = 'none';
            generationTimeDisplay.style.display = 'none';

            const formData = new FormData();
            const reqId = `eval-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
            formData.append('prompt', evalPromptInput.value);
            formData.append('llm_engine', llmEngineSelect.value);
            formData.append('openai_api_key', apiKeyOpenAIInput ? apiKeyOpenAIInput.value : '');
            formData.append('gemini_api_key', apiKeyGeminiInput ? apiKeyGeminiInput.value : '');
            formData.append('force_python_pptx', forcePythonCheckbox && forcePythonCheckbox.checked ? 'on' : 'off');
            formData.append('loop_mode', loopMode ? 'on' : 'off');
            if (loopIterationsInput && loopIterationsInput.value) formData.append('loop_iterations', loopIterationsInput.value);
            formData.append('client_request_id', reqId);
            currentRequestId = reqId;
            startProgressPolling(currentRequestId);

            try {
                const filePath = `/files/${originalFileInput.value}`;
                const fileResponse = await fetch(filePath);
                if (!fileResponse.ok) throw new Error(`File not found at ${filePath}`);
                const fileBlob = await fileResponse.blob();
                formData.append('file', fileBlob, originalFileInput.value.split('/').pop());
            } catch (error) {
                displayEvalMessage(`Error fetching original file: ${error.message}`, 'error');
                if (evalLoader) evalLoader.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/process_eval_prediction', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                if (response.ok) {
                    if (!result.prediction_pdf_name && result.public_preview_url) {
                        showNotification('Preview Notice', 'PDF preview unavailable. Using Microsoft Office Viewer.', true);
                    }
                    displayEvalMessage(result.message || 'Processing successful!', 'success');
                    if (result.request_id) {
                        currentRequestId = result.request_id;
                        startProgressPolling(currentRequestId);
                    }
                    if (result.generation_time_seconds !== undefined) {
                        generationTimeDisplay.textContent = `⏱️ Generation time: ${result.generation_time_seconds}s`;
                        generationTimeDisplay.style.display = 'block';
                        currentGenerationTime = result.generation_time_seconds;
                    }

                    currentLLMEngine = llmEngineSelect.value;

                    const notifTitle = result.loop_mode_enabled ? 'PPTPilot - Loop Complete' : 'PPTPilot - Prediction Complete';
                    const notifChunks = [];
                    if (result.loop_mode_enabled) {
                        notifChunks.push(`Iterations: ${result.loop_iterations_completed || '?'} / ${result.loop_iterations_requested || '?'}`);
                    }
                    if (result.generation_time_seconds !== undefined) {
                        notifChunks.push(`Duration: ${result.generation_time_seconds}s`);
                    }
                    showNotification(notifTitle, notifChunks.join(' • ') || 'Processing finished', true);

                    if (result.loop_mode_enabled && Array.isArray(result.loop_iteration_summaries)) {
                        appendEvalProgress('Loop summary:');
                        result.loop_iteration_summaries.forEach(entry => {
                            const status = entry.error ? `Error: ${entry.error}` : (entry.message || 'Completed');
                            appendEvalProgress(`Iteration ${entry.iteration}: ${status}`);
                        });
                    }

                    if (result.modified_pptx_filepath) {
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('prediction_pptx_path', result.modified_pptx_filepath);
                        if (result.generation_time_seconds !== undefined) {
                            currentUrl.searchParams.set('generation_time', result.generation_time_seconds);
                        }
                        if (currentLLMEngine) {
                            currentUrl.searchParams.set('llm_engine', currentLLMEngine);
                        }
                        window.location.href = currentUrl.toString();
                    } else if (result.error) {
                        displayEvalMessage(`Error: ${result.error}`, 'error');
                    }
                } else {
                    displayEvalMessage(`Error: ${result.error || 'Failed to process.'}`, 'error');
                    showNotification('PPTPilot - Prediction Failed', result.error || 'Failed to process', false);
                }
            } catch (error) {
                displayEvalMessage(`Network error: ${error.message}`, 'error');
                showNotification('PPTPilot - Prediction Failed', error.message, false);
            } finally {
                if (evalLoader) evalLoader.style.display = 'none';
            }
        }

        judgeButton.addEventListener('click', async function () {
            const modelId = judgeModelSelect ? judgeModelSelect.value : '';
            const validation = validateApiKeys(modelId);
            if (!validation.valid) {
                displayEvalMessage(`Error: ${validation.provider} API Key is required for judge model '${modelId}'.`, 'error');
                return;
            }

            if (evalLoader) evalLoader.style.display = 'block';
            judgementDisplay.style.display = 'none';
            judgeTimeDisplay.style.display = 'none';
            evalMessageArea.innerHTML = '';

            try {
                const response = await fetch('/judge_arena', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prediction_pptx_name: currentPredictionPptxName,
                        pair_name: selectedPairName,
                        judge_model: judgeModelSelect ? judgeModelSelect.value : undefined,
                        openai_api_key: apiKeyOpenAIInput ? apiKeyOpenAIInput.value : '',
                        gemini_api_key: apiKeyGeminiInput ? apiKeyGeminiInput.value : ''
                    })
                });

                const judgement = await response.json();
                if (response.ok) {
                    if (judgement.error) {
                        displayEvalMessage(`Judging error: ${judgement.error}`, 'error');
                        showNotification('PPTPilot - Judging Failed', judgement.error, false);
                    } else {
                        if (judgementDisplay) {
                            judgementDisplay.innerHTML = formatJudgementHTML(judgement);
                            judgementDisplay.style.display = 'block';
                        }
                        if (judgement.judge_time_seconds !== undefined) {
                            judgeTimeDisplay.textContent = `⏱️ Judge time: ${judgement.judge_time_seconds}s`;
                            judgeTimeDisplay.style.display = 'block';
                        }
                        const ifScore = judgement.instruction_following_score ?? 'N/A';
                        const vpScore = judgement.visual_quality_score ?? 'N/A';
                        appendEvalProgress(`Judge result → IF: ${ifScore}/5, VQ: ${vpScore}/5`);
                        showNotification(
                            'PPTPilot - Judging Complete',
                            `IF: ${ifScore}/5, VQ: ${vpScore}/5 (${judgement.judge_time_seconds || '?'}s)`,
                            true
                        );
                        saveResultsToCSV(judgement);
                    }
                } else {
                    displayEvalMessage(`Server error during judging: ${judgement.error}`, 'error');
                    showNotification('PPTPilot - Judging Failed', judgement.error, false);
                }
            } catch (error) {
                displayEvalMessage(`Network error during judging: ${error.message}`, 'error');
                showNotification('PPTPilot - Judging Failed', error.message, false);
            } finally {
                if (evalLoader) evalLoader.style.display = 'none';
            }
        });

        async function saveResultsToCSV(judgement) {
            try {
                const resultData = {
                    pair_name: selectedPairName,
                    llm_engine: currentLLMEngine || 'unknown',
                    generation_time_seconds: currentGenerationTime,
                    judge_model: judgeModelSelect ? judgeModelSelect.value : 'unknown',
                    judge_time_seconds: judgement.judge_time_seconds,
                    instruction_following_score: judgement.instruction_following_score,
                    visual_quality_score: judgement.visual_quality_score,
                    instruction_following_reason: judgement.instruction_following_reason || '',
                    visual_quality_reason: judgement.visual_quality_reason || ''
                };

                const response = await fetch('/save_evaluation_result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resultData)
                });

                if (!response.ok) console.error('Failed to save results to CSV');
            } catch (error) {
                console.error('Error saving results to CSV:', error);
            }
        }

        function formatJudgementHTML(judgement) {
            const ifScore = (judgement.instruction_following_score ?? 'N/A');
            const vpScore = (judgement.visual_quality_score ?? 'N/A');
            const ifReason = judgement.instruction_following_reason || 'No reason provided.';
            const vpReason = judgement.visual_quality_reason || 'No reason provided.';
            const hasReasoning = !!(judgement.reasoning && String(judgement.reasoning).trim());
            const improvement = judgement.suggested_improvement || 'None';

            const reasoningSection = hasReasoning ? `
                <div class="mt-2">
                    <p class="font-semibold text-slate-700 text-sm">Overall reasoning</p>
                    <p class="text-xs text-slate-600">${judgement.reasoning}</p>
                </div>
            ` : '';

            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                    <div class="p-3 border border-slate-200 rounded-md bg-white">
                        <p class="text-xs font-medium text-slate-700">Instruction Following</p>
                        <p class="text-xl font-bold text-slate-900">${ifScore}/5</p>
                        <p class="mt-1 text-xs text-slate-600">${ifReason}</p>
                    </div>
                    <div class="p-3 border border-slate-200 rounded-md bg-white">
                        <p class="text-xs font-medium text-slate-700">Visual Quality</p>
                        <p class="text-xl font-bold text-slate-900">${vpScore}/5</p>
                        <p class="mt-1 text-xs text-slate-600">${vpReason}</p>
                    </div>
                </div>
                ${reasoningSection}
                <div class="mt-2">
                    <p class="font-semibold text-slate-700 text-sm">Suggested improvement</p>
                    <p class="text-xs text-slate-600">${improvement}</p>
                </div>
            `;
        }

        function displayEvalMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-md text-sm border ${type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`;
            messageDiv.textContent = message;
            evalMessageArea.innerHTML = '';
            evalMessageArea.appendChild(messageDiv);
        }

        function appendEvalProgress(message) {
            const row = document.createElement('div');
            row.className = 'text-xs text-slate-600';
            row.textContent = message;
            evalMessageArea.appendChild(row);
            evalMessageArea.scrollTop = evalMessageArea.scrollHeight;
        }

        async function pollProgress(requestId) {
            try {
                const res = await fetch(`/progress?request_id=${encodeURIComponent(requestId)}&since=${progressIndex}`);
                const data = await res.json();
                const msgs = data.messages || [];
                msgs.forEach(m => appendEvalProgress(m));
                progressIndex = data.next_index || progressIndex;
            } catch (_) { }
        }

        function startProgressPolling(requestId) {
            if (progressInterval) clearInterval(progressInterval);
            progressIndex = 0;
            appendEvalProgress('Starting live progress...');
            progressInterval = setInterval(() => pollProgress(requestId), 800);
            setTimeout(() => { if (progressInterval) { clearInterval(progressInterval); appendEvalProgress('Progress ended.'); } }, 120000);
        }

        const savedPythonToggle = localStorage.getItem('pptpilot_force_python');
        if (forcePythonCheckbox) {
            if (savedPythonToggle !== null) forcePythonCheckbox.checked = savedPythonToggle === 'true';
            forcePythonCheckbox.addEventListener('change', () => localStorage.setItem('pptpilot_force_python', forcePythonCheckbox.checked ? 'true' : 'false'));
        }

        if (loopIterationsInput) {
            const savedLoops = localStorage.getItem('pptpilot_loop_iterations');
            if (savedLoops) loopIterationsInput.value = savedLoops;
            updateLoopPreview();
            loopIterationsInput.addEventListener('input', () => {
                localStorage.setItem('pptpilot_loop_iterations', loopIterationsInput.value || '1');
                updateLoopPreview();
            });
        }

        // Manual Prediction Upload Logic
        const manualUploadInput = document.getElementById('manualPredictionUpload');
        if (manualUploadInput) {
            manualUploadInput.addEventListener('change', async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                if (evalLoader) evalLoader.style.display = 'block';
                displayEvalMessage('Uploading manual prediction...', 'info');

                try {
                    const response = await fetch('/upload_only', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (response.ok) {
                        // Update state
                        const savedFilename = data.preview_url.split('/').pop();
                        currentPredictionPptxName = savedFilename;

                        // Update UI
                        const pdfViewer = document.getElementById('predictionPdfViewer');
                        const filenameDisplay = document.getElementById('predictionFilenameDisplay');

                        if (pdfViewer) {
                            if (data.pdf_preview_url) {
                                if (pdfViewer.tagName === 'IFRAME') {
                                    pdfViewer.src = data.pdf_preview_url;
                                } else {
                                    // Replace div with iframe
                                    const iframe = document.createElement('iframe');
                                    iframe.id = 'predictionPdfViewer';
                                    iframe.className = 'pdf-viewer';
                                    iframe.src = data.pdf_preview_url;
                                    pdfViewer.replaceWith(iframe);
                                }
                            } else {
                                // Fallback to MS Viewer if PDF preview is missing
                                if (data.public_preview_url) {
                                    const publicUrl = data.public_preview_url.startsWith('http') ? data.public_preview_url : toAbsoluteUrl(data.public_preview_url);
                                    if (pdfViewer.tagName === 'IFRAME') {
                                        setIframeWithFallback(pdfViewer, publicUrl);
                                    } else {
                                        const iframe = document.createElement('iframe');
                                        iframe.id = 'predictionPdfViewer';
                                        iframe.className = 'pdf-viewer';
                                        setIframeWithFallback(iframe, publicUrl);
                                        pdfViewer.replaceWith(iframe);
                                    }
                                } else {
                                    displayEvalMessage('Upload successful, but preview failed.', 'warning');
                                }
                            }
                        }

                        if (filenameDisplay) {
                            filenameDisplay.textContent = file.name;
                            filenameDisplay.title = file.name;
                        }

                        displayEvalMessage('Prediction uploaded successfully. Ready to judge.', 'success');
                        showNotification('Upload Complete', 'Manual prediction loaded.', true);
                    } else {
                        throw new Error(data.error || 'Upload failed');
                    }
                } catch (error) {
                    displayEvalMessage(`Upload error: ${error.message}`, 'error');
                    showNotification('Upload Failed', error.message, false);
                } finally {
                    if (evalLoader) evalLoader.style.display = 'none';
                    manualUploadInput.value = '';
                }
            });
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Helper functions for Microsoft Live viewer with fallbacks
        function toAbsoluteUrl(u) {
            try { return new URL(u, window.location.origin).href; } catch { return u; }
        }

        function buildOfficeViewerUrl(fileUrl) {
            const u = encodeURIComponent(fileUrl);
            return `https://view.officeapps.live.com/op/embed.aspx?src=${u}`;
        }

        function buildGoogleViewerUrl(fileUrl) {
            const u = encodeURIComponent(fileUrl);
            return `https://docs.google.com/gview?url=${u}&embedded=true`;
        }

        function setIframeWithFallback(iframe, fileUrl) {
            iframe.src = buildOfficeViewerUrl(fileUrl);
            const fallbackTimer = setTimeout(() => {
                iframe.src = buildGoogleViewerUrl(fileUrl);
            }, 3500);
            iframe.addEventListener('load', () => clearTimeout(fallbackTimer), { once: true });
        }

        function joinUrl(base, path) {
            return new URL(path, base).href;
        }

        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            console.warn('Office preview cannot load files from localhost. Use a public URL via ngrok/Cloudflare Tunnel or deploy to staging.');
            setTimeout(() => {
                if (typeof displayChatMessage === 'function') {
                    displayChatMessage('Office preview cannot load files from localhost. Use ngrok/Cloudflare Tunnel or deploy to staging for full functionality.', 'error');
                }
            }, 1000);
        }
    </script>
    <script>
        // Chat tab logic
        const chatPptForm = document.getElementById('chatPptForm');
        const chatForm = document.getElementById('chatForm');
        const chatLoader = document.getElementById('chatLoader');
        const chatMessageArea = document.getElementById('chatMessageArea');
        const chatHistory = document.getElementById('chatHistory');
        const chatModifiedPptIframe = document.getElementById('chatModifiedPptIframe');
        const chatModifiedPptxDownload = document.getElementById('chatModifiedPptxDownload');
        const chatEditHistoryContainer = document.getElementById('chatEditHistoryContainer');
        const chatFileInput = document.getElementById('chat_ppt_file');
        const chatLLMSelect = document.getElementById('chat_llm_engine');
        const chatPreviewSection = document.getElementById('chatPreviewSection');
        const BACKEND_URL = window.location.origin;
        let chatProgressInterval = null;
        let chatProgressIndex = 0;
        let currentSessionId = null;
        let chatHistoryData = [];
        let editHistoryData = [];

        function displayChatMessage(message, type) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-md text-sm border ${type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`;
            div.textContent = message;
            chatMessageArea.innerHTML = '';
            chatMessageArea.appendChild(div);
        }

        function appendChatProgress(message) {
            const row = document.createElement('div');
            row.className = 'text-xs text-slate-600';
            row.textContent = message;
            chatMessageArea.appendChild(row);
            chatMessageArea.scrollTop = chatMessageArea.scrollHeight;
        }

        async function pollChatProgress(requestId) {
            try {
                const res = await fetch(`/progress?request_id=${encodeURIComponent(requestId)}&since=${chatProgressIndex}`);
                const data = await res.json();
                const msgs = data.messages || [];
                msgs.forEach(m => appendChatProgress(m));
                chatProgressIndex = data.next_index || chatProgressIndex;
            } catch (_) { }
        }

        function startChatProgressPolling(requestId) {
            if (chatProgressInterval) clearInterval(chatProgressInterval);
            chatProgressIndex = 0;
            appendChatProgress('Starting live progress...');
            chatProgressInterval = setInterval(() => pollChatProgress(requestId), 800);
            setTimeout(() => { if (chatProgressInterval) { clearInterval(chatProgressInterval); appendChatProgress('Progress ended.'); } }, 120000);
        }

        function renderChatHistory() {
            chatHistory.innerHTML = '';
            chatHistoryData.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'chat-history-entry';
                const userBubble = document.createElement('div');
                userBubble.className = 'chat-bubble-user';
                userBubble.textContent = entry.prompt;
                entryDiv.appendChild(userBubble);
                const llmBubble = document.createElement('div');
                llmBubble.className = 'chat-bubble-llm';
                llmBubble.textContent = entry.response || 'No response.';
                entryDiv.appendChild(llmBubble);
                if (entry.downloadUrl) {
                    const link = document.createElement('a');
                    link.href = entry.downloadUrl;
                    link.target = '_blank';
                    link.rel = 'noopener';
                    link.className = 'text-blue-600 underline mt-1';
                    link.textContent = 'Download this version';
                    entryDiv.appendChild(link);
                }
                chatHistory.appendChild(entryDiv);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function renderEditHistory() {
            chatEditHistoryContainer.innerHTML = '';
            if (editHistoryData.length === 0) {
                chatEditHistoryContainer.innerHTML = '<div class="text-gray-500">No previous edits yet.</div>';
                return;
            }
            editHistoryData.forEach((edit, idx) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'history-entry';
                entryDiv.innerHTML = `
                <div class="font-semibold mb-1">Edit #${idx + 1}</div>
                <div class="mb-1 text-sm text-gray-700"><span class="font-medium">Prompt:</span> ${edit.prompt}</div>
                <div class="mb-1 text-sm text-gray-700"><span class="font-medium">LLM Response:</span> ${edit.response || 'No response.'}</div>
                <div class="flex gap-3 mt-1">
                    <a href="${edit.downloadUrl}" target="_blank" rel="noopener" class="text-blue-600 underline">Download PPTX</a>
                    <a href="${edit.previewUrl}" target="_blank" rel="noopener" class="text-blue-600 underline">Preview</a>
                </div>
            `;
                chatEditHistoryContainer.appendChild(entryDiv);
            });
        }



        chatLLMSelect?.addEventListener('change', () => updateEnginePreview('chat'));

        chatFileInput.addEventListener('change', async () => {
            const file = chatFileInput.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const backend = BACKEND_URL.replace(/\/+$/, '');
                const response = await fetch(`${BACKEND_URL}/upload_only`, { method: 'POST', body: formData });
                if (response.ok) {
                    const data = await response.json();
                    const pdfUrl = data.pdf_preview_url ? joinUrl(backend, data.pdf_preview_url) : null;
                    const publicUrl = data.public_preview_url ? (data.public_preview_url.startsWith('http') ? data.public_preview_url : toAbsoluteUrl(data.public_preview_url)) : toAbsoluteUrl(data.preview_url);
                    if (pdfUrl) {
                        chatModifiedPptIframe.src = pdfUrl;
                    } else if (publicUrl) {
                        setIframeWithFallback(chatModifiedPptIframe, publicUrl);
                    }
                    chatPreviewSection.style.display = 'flex';
                    chatModifiedPptxDownload.href = data.preview_url ? joinUrl(backend, data.preview_url) : '#';
                }
            } catch (err) {
                console.error('Preview upload failed', err);
            }
        });

        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const modelId = chatLLMSelect.value;
            const validation = validateApiKeys(modelId);
            if (!validation.valid) {
                displayChatMessage(`Error: ${validation.provider} API Key is required for model '${modelId}'. Please enter it in the top bar.`, 'error');
                return;
            }

            if (chatLoader) chatLoader.style.display = 'block';
            const prompt = document.getElementById('chat_prompt').value;

            if (!currentSessionId && !chatFileInput.files[0]) {
                displayChatMessage('Please upload a PPTX file first before sending instructions.', 'error');
                if (chatLoader) chatLoader.style.display = 'none';
                return;
            }

            const formData = new FormData(chatPptForm);
            formData.append('prompt', prompt);
            formData.append('openai_api_key', apiKeyOpenAIInput ? apiKeyOpenAIInput.value : '');
            formData.append('gemini_api_key', apiKeyGeminiInput ? apiKeyGeminiInput.value : '');

            let endpoint = '';
            if (currentSessionId) {
                endpoint = `${BACKEND_URL}/api/edit`;
                formData.append('session_id', currentSessionId);
                formData.delete('file');
            } else {
                endpoint = `${BACKEND_URL}/process_ppt`;
            }

            try {
                const backend = BACKEND_URL.replace(/\/+$/, '');
                const response = await fetch(endpoint, { method: 'POST', body: formData });
                if (chatLoader) chatLoader.style.display = 'none';
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chat_prompt').value = '';

                    if (data.session_id && !currentSessionId) {
                        currentSessionId = data.session_id;
                        chatFileInput.disabled = true;
                        displayChatMessage(`Session started: ${currentSessionId}`, 'success');
                    } else {
                        displayChatMessage(data.message || 'Processing successful!', 'success');
                    }

                    if (data.request_id) startChatProgressPolling(data.request_id);

                    if (data.modified_pptx_url) {
                        const pdfUrl = data.pdf_preview_url ? joinUrl(backend, data.pdf_preview_url) : null;
                        const publicUrl = data.public_preview_url || toAbsoluteUrl(`${backend}${data.modified_pptx_url}`);
                        if (pdfUrl) {
                            chatModifiedPptIframe.src = pdfUrl;
                        } else {
                            // Ensure publicUrl is absolute for MS Viewer
                            const absPublicUrl = publicUrl.startsWith('http') ? publicUrl : toAbsoluteUrl(publicUrl);
                            setIframeWithFallback(chatModifiedPptIframe, absPublicUrl);
                        }
                        chatPreviewSection.style.display = 'flex';
                        chatModifiedPptxDownload.href = `${backend}${data.modified_pptx_download_url}`;
                    }

                    chatHistoryData.push({
                        prompt: prompt,
                        response: data.summary || data.message || (data.reason_for_no_modification ? `No modifications: ${data.reason_for_no_modification}` : 'Success'),
                        downloadUrl: data.modified_pptx_download_url ? `${backend}${data.modified_pptx_download_url}` : null
                    });
                    renderChatHistory();

                    if (data.session_id) {
                        editHistoryData = [];
                        for (let i = 1; i < chatHistoryData.length; i++) {
                            const editNum = i;
                            const promptText = chatHistoryData[i - 1].prompt;
                            const responseText = chatHistoryData[i - 1].response;
                            const downloadUrl = joinUrl(backend, `/download_original/${currentSessionId}/history_${editNum}.pptx`);
                            const previewUrl = buildOfficeViewerUrl(downloadUrl);
                            editHistoryData.push({
                                prompt: promptText, response: responseText, downloadUrl, previewUrl
                            });
                        }
                        renderEditHistory();
                    }
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        const htmlText = await response.text();
                        displayChatMessage(`Server error: Received HTML instead of JSON. Check server logs.`, 'error');
                        console.error('Server returned HTML:', htmlText.substring(0, 200));
                    } else {
                        try {
                            const errorData = await response.json();
                            displayChatMessage(`Error: ${errorData.error || 'Failed to process the presentation.'}`, 'error');
                        } catch (jsonError) {
                            displayChatMessage(`Server error: Invalid JSON response`, 'error');
                            console.error('JSON parse error:', jsonError);
                        }
                    }
                }
            } catch (error) {
                if (chatLoader) chatLoader.style.display = 'none';
                displayChatMessage(`Network error: ${error.message}`, 'error');
                console.error('Network error details:', error);
            }
        });

        window.onload = () => {
            chatHistoryData = [];
            editHistoryData = [];
            renderChatHistory();
            renderEditHistory();
            chatModifiedPptIframe.src = '';
            chatModifiedPptxDownload.href = '#';
            chatPreviewSection.style.display = 'none';
            chatFileInput.disabled = false;
            currentSessionId = null;
        };
    </script>
</body>

</html>